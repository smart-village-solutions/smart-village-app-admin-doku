# Module Template System - Specification Delta

## ADDED Requirements

### Requirement: Gemeinsame Datenverwaltung

The system SHALL provide a central file (`yml/global.yml`) for common module information.

#### Scenario: Global.yml enthält gemeinsame Felder

- **GIVEN** alle Module nutzen dieselben Werte für bestimmte Felder
- **WHEN** `yml/global.yml` erstellt wird
- **THEN** enthält sie folgende Felder:
  - `opencode_repository`: Gemeinsames Repository für alle Module
  - `deployed_in_municipalities`: Liste aller 42 Kommunen
  - `development_status`: Standard-Status (z.B. "Production")
- **AND** diese Werte werden bei der YAML-Generierung automatisch eingefügt

#### Scenario: Aktualisierung gemeinsamer Daten

- **WHEN** eine neue Kommune hinzugefügt wird
- **AND** `deployed_in_municipalities` in `yml/global.yml` aktualisiert wird
- **AND** alle Module mit `generate_module_yaml.py --all` regeneriert werden
- **THEN** enthalten alle generierten YAML-Dateien die neue Kommune
- **AND** nur `yml/global.yml` muss im Git committed werden

### Requirement: Modul-spezifische Teilinformationen

The system SHALL store module-specific information in separate files within `yml/modules/`.

#### Scenario: Modulspezifische Datei erstellen

- **GIVEN** ein neues Modul "Abfallkalender" wird erstellt
- **WHEN** die Teilinformationen gespeichert werden
- **THEN** wird die Datei `yml/modules/abfallkalender.yml` erstellt
- **AND** sie enthält nur modulspezifische Felder:
  - `name`: "Abfallkalender"
  - `topic`: "abfallkalender"
  - `short_description`: "..."
  - `usage_scenario`: "..."
  - `description`: "..."
  - `roadmap`: [...]
  - `interfaces`: [...]
  - `dependencies`: [...]
  - `external_services`: [...]
  - `customization_options`: [...]
  - `involved_actors`: [...]
- **AND** sie enthält KEINE gemeinsamen Felder (opencode_repository, deployed_in_municipalities)

#### Scenario: Bestehende modulspezifische Datei bearbeiten

- **WHEN** ein Redakteur `yml/modules/abfallkalender.yml` direkt bearbeitet
- **AND** Änderungen speichert
- **AND** `python scripts/generate_module_yaml.py --module abfallkalender` ausführt
- **THEN** wird `yml/abfallkalender.yml` mit den aktualisierten Daten regeneriert
- **AND** globale Felder bleiben unverändert

### Requirement: Template-basierte Generierung

The system SHALL generate YAML files by merging global and module-specific data.

#### Scenario: Merge-Logik

- **GIVEN** `yml/global.yml` mit gemeinsamen Feldern
- **AND** `yml/modules/abfallkalender.yml` mit spezifischen Feldern
- **WHEN** `generate_module_yaml.py` ausgeführt wird
- **THEN** werden beide Dateien eingelesen
- **AND** modulspezifische Felder überschreiben globale Felder (falls Konflikt)
- **AND** das Ergebnis wird in `yml/abfallkalender.yml` geschrieben
- **AND** entspricht dem `app-module.schema.json`

#### Scenario: Schema-Konformität sicherstellen

- **WHEN** eine YAML-Datei generiert wird
- **THEN** enthält sie alle Pflichtfelder aus dem Schema:
  - `name` (aus Modul-Datei)
- **AND** enthält sie alle optionalen Felder, die bereitgestellt wurden
- **AND** enthält sie KEINE zusätzlichen Felder (`additionalProperties: false`)

### Requirement: Auto-Generated Marker

The system SHALL mark generated files as auto-generated.

#### Scenario: Header-Kommentar in generierter Datei

- **WHEN** eine YAML-Datei generiert wird
- **THEN** beginnt sie mit folgendem Kommentar:
  ```yaml
  # AUTO-GENERATED FROM yml/modules/[modulname].yml + yml/global.yml
  # DO NOT EDIT THIS FILE DIRECTLY - Edit the source files instead
  # Last generated: 2025-11-09 14:30:00
  ```
- **AND** der Kommentar warnt vor direkter Bearbeitung
- **AND** der Zeitstempel zeigt die letzte Generierung

### Requirement: Verzeichnisstruktur

The system SHALL maintain a clear separation between source and generated files.

#### Scenario: Dateistruktur

- **GIVEN** das Projekt nutzt das Template-System
- **THEN** existiert folgende Struktur:
  ```
  yml/
  ├── global.yml                    # Gemeinsame Daten
  ├── modules/                      # Quell-Dateien (zu committen)
  │   ├── abfallkalender.yml
  │   ├── maengelmelder.yml
  │   └── ...
  ├── nachrichten.yml               # Manuell erstellt (bestehend)
  ├── veranstaltungen.yml           # Manuell erstellt (bestehend)
  ├── abfallkalender.yml            # Auto-generiert
  ├── maengelmelder.yml             # Auto-generiert
  └── ...
  ```
- **AND** nur Dateien in `yml/modules/` und `yml/global.yml` werden ins Git committed
- **AND** generierte Dateien können optional in `.gitignore` aufgenommen werden (bei Build-Time-Generierung)

### Requirement: Schema-Validation Override

The system SHALL allow module-specific values to override global values.

#### Scenario: Modul überschreibt globalen Wert

- **GIVEN** `yml/global.yml` enthält `development_status: "Production"`
- **AND** `yml/modules/chatbot.yml` enthält `development_status: "Beta"`
- **WHEN** `yml/chatbot.yml` generiert wird
- **THEN** enthält die Datei `development_status: "Beta"`
- **AND** nicht den globalen Wert "Production"

#### Scenario: Modul überschreibt globale Kommune-Liste

- **GIVEN** `yml/global.yml` enthält `deployed_in_municipalities` mit 42 Kommunen
- **AND** `yml/modules/chatbot.yml` enthält nur:
  ```yaml
  deployed_in_municipalities:
    - "Bad Belzig"
    - "Kiel"
  ```
- **WHEN** `yml/chatbot.yml` generiert wird
- **THEN** enthält die Datei nur die 2 Kommunen aus der Modul-Datei
- **AND** nicht die globale Liste mit 42 Kommunen
- **AND** dies ist nützlich für Module, die nur in wenigen Kommunen eingesetzt werden

#### Scenario: Modul nutzt globalen Wert

- **GIVEN** `yml/global.yml` enthält `development_status: "Production"`
- **AND** `yml/modules/abfallkalender.yml` enthält KEIN `development_status` Feld
- **WHEN** `yml/abfallkalender.yml` generiert wird
- **THEN** enthält die Datei `development_status: "Production"`
- **AND** der globale Wert wird verwendet

### Requirement: Template-Dokumentation

The system SHALL document the template structure.

#### Scenario: Beispiel-Template bereitstellen

- **GIVEN** ein neuer Redakteur möchte ein Modul erstellen
- **WHEN** die Dokumentation gelesen wird
- **THEN** findet der Nutzer ein vollständiges Beispiel für `yml/modules/beispiel.yml`
- **AND** Erklärungen zu jedem Feld
- **AND** Hinweise, welche Felder global vs. individuell sind
- **AND** Best Practices für Beschreibungstexte
